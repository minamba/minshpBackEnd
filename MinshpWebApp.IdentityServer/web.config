<?xml version="1.0" encoding="utf-8"?>
<configuration>
	<location path="." inheritInChildApplications="false">
		<system.webServer>
			<handlers>
				<add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
			</handlers>

			<!-- 🔥 AJOUT CRITIQUE : Autorisation des verbs HTTP -->
			<security>
				<requestFiltering>
					<verbs allowUnlisted="true">
						<add verb="GET" allowed="true" />
						<add verb="POST" allowed="true" />
						<add verb="PUT" allowed="true" />
						<add verb="DELETE" allowed="true" />
						<add verb="PATCH" allowed="true" />
						<add verb="OPTIONS" allowed="true" />
					</verbs>
					<!-- Optionnel : augmenter la limite de taille si besoin -->
					<requestLimits maxAllowedContentLength="30000000" />
					<!-- 30MB -->
				</requestFiltering>
			</security>

			<!-- IMPORTANT: Configuration spécifique pour résoudre l'erreur 405 -->
			<aspNetCore
				processPath="dotnet"
				arguments=".\MinshpWebApp.IdentityServer.dll"
				stdoutLogEnabled="true"
				stdoutLogFile=".\logs\stdout"
				hostingModel="inprocess">

				<!-- Configuration pour les proxies LWS -->
				<forwardedHeaders />

				<environmentVariables>
					<!-- Environnement -->
					<environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Production" />
					<environmentVariable name="ASPNETCORE_FORWARDEDHEADERS_ENABLED" value="true" />

					<!-- Connexion base AUTH -->
					<environmentVariable name="ConnectionStrings__MainDb" value="Server=..." />

					<!-- 🔥 CHANGEMENT CRITIQUE : Utiliser des routes API standard au lieu de /connect -->
					<environmentVariable name="Auth__Issuer" value="https://minshp.com" />
					<environmentVariable name="Auth__TokenEndpoint" value="/api/auth/token" />
					<environmentVariable name="Auth__AuthorizeEndpoint" value="/api/auth/authorize" />

					<!-- CORS - Autoriser le même domaine -->
					<environmentVariable name="CORS__Origins" value="https://minshp.com" />
					<environmentVariable name="CORS__Methods" value="GET,POST,OPTIONS" />

					<!-- URLs SPA -->
					<environmentVariable name="Spa__RedirectUri" value="https://minshp.com/callback" />
					<environmentVariable name="Spa__PostLogoutUri" value="https://minshp.com/" />

					<!-- Client confidentiel -->
					<environmentVariable name="Clients__MinshpApi__ClientId" value="minshp-api-client" />
					<environmentVariable name="Clients__MinshpApi__Secret" value="REMPLACE-MOI-par-un-secret-solide" />

					<!-- URL API -->
					<environmentVariable name="Api__BaseUrl" value="https://minshp.com" />

					<!-- 🔥 Configuration pour éviter les blocages LWS -->
					<environmentVariable name="OpenIddict__DisableHttpsRequirement" value="true" />
					<environmentVariable name="ASPNETCORE_URLS" value="http://*;https://*" />
				</environmentVariables>
			</aspNetCore>

			<!-- 🔥 Règles de réécriture pour gérer les routes SPA -->
			<rewrite>
				<rules>
					<rule name="SPA Routes" stopProcessing="true">
						<match url=".*" />
						<conditions logicalGrouping="MatchAll">
							<add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
							<add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
							<add input="{REQUEST_URI}" pattern="^/(api|connect|auth)" negate="true" />
						</conditions>
						<action type="Rewrite" url="/" />
					</rule>
				</rules>
			</rewrite>
		</system.webServer>
	</location>
</configuration>